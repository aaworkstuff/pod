<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TSI Placement Task – Questionnaire Mock (LSC Exemptions)</title>
  <style>
    :root {
      --ps-navy:#2c3e50; --ps-blue:#1b6aa5; --ps-sky:#e8f2fa; --ps-gray:#f7f8f9; --ps-border:#d5dbe0;
      --ps-green:#2e7d32; --ps-red:#c0392b; --ps-text:#1f2937; --warning:#8a6d1a; --warning-bg:#fff8e1;
      --space-1:6px; --space-2:10px; --space-3:14px; --space-4:18px; --space-5:24px; --radius:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Segoe UI, Roboto, Helvetica, Arial, sans-serif;color:var(--ps-text);background:#fff;line-height:1.4}

    /* Top header */
    .topbar{display:flex;align-items:center;gap:var(--space-3);padding:var(--space-2) var(--space-4);background:linear-gradient(90deg,var(--ps-navy),#223445);color:#fff}
    .topbar .app-title{font-size:18px;font-weight:600}
    .env-pill{margin-left:auto;font-size:12px;background:#3a5166;padding:4px 10px;border-radius:999px}

    /* Layout */
    .layout{display:grid;grid-template-columns:280px 1fr;min-height:calc(100vh - 56px)}
    .sidebar{background:var(--ps-gray);border-right:1px solid var(--ps-border);padding:var(--space-4)}

    .step{display:flex;align-items:flex-start;gap:var(--space-2);padding:12px;border-radius:10px;margin-bottom:10px;border:1px solid transparent;cursor:pointer}
    .step:hover{background:#eef2f6}
    .step.active{background:var(--ps-sky);border-color:var(--ps-border)}
    .step .index{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;background:#fff;border:1px solid var(--ps-border);font-size:12px;font-weight:700}
    .step.active .index{background:var(--ps-blue);color:#fff;border-color:var(--ps-blue)}
    .step .label{font-size:14px}

    .content{padding:var(--space-5)}

    /* Card */
    .card{border:1px solid var(--ps-border);border-radius:var(--radius);background:#fff;box-shadow:0 1px 0 rgba(16,24,40,.03)}
    .card .card-hd{padding:var(--space-4) var(--space-5);border-bottom:1px solid var(--ps-border);background:linear-gradient(0deg,#fff,var(--ps-gray))}
    .card .card-bd{padding:var(--space-5);}

    .row{display:grid;gap:var(--space-4)}
    .row.tight{gap:var(--space-2)}
    .row.cols-2{grid-template-columns:1fr 1fr}
    .row.cols-3{grid-template-columns:repeat(3,1fr)}

    /* Inputs */
    label{font-size:14px;font-weight:700;margin-bottom:6px;display:block}
    .hint{font-size:12px;color:#5c6b78;margin-top:6px}
    input[type="text"], input[type="date"], select{width:100%;padding:12px;border:1px solid var(--ps-border);border-radius:10px;background:#fff}
    .radio-group, .checklist{display:grid;gap:10px}
    .radio, .check{display:flex;align-items:flex-start;gap:10px}

    /* Buttons */
    .actions{display:flex;gap:12px;justify-content:flex-end;padding:var(--space-4) var(--space-5)}
    .btn{appearance:none;border:1px solid var(--ps-border);background:#fff;padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:700}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn.primary{background:var(--ps-blue);border-color:var(--ps-blue);color:#fff}
    .btn.ghost{background:#fff;border-color:var(--ps-border)}

    /* Progress */
    .progress{height:10px;background:#eef2f5;border-radius:999px;overflow:hidden;margin-top:8px}
    .progress > div{height:100%;width:0;background:linear-gradient(90deg,var(--ps-blue),#3aa0ff)}

    /* Summary */
    .summary-list{display:grid;gap:var(--space-3)}
    .summary-card{border:1px solid var(--ps-border);border-radius:12px;padding:14px 16px}
    .pill{display:inline-flex;align-items:center;gap:6px;font-size:12px;background:#eef7ee;border:1px solid #cfe9d0;color:#1e6f23;border-radius:999px;padding:6px 10px}
    .pill.bad{background:#fff3f2;border-color:#f1d0cd;color:#a63a2e}
    .pill.note{background:var(--warning-bg);border-color:#f1e3a1;color:var(--warning)}
    .muted{color:#6b7b88}

    details{border:1px dashed var(--ps-border);border-radius:10px;padding:12px 14px;background:#fff}
    details > summary{cursor:pointer;font-weight:700;margin-bottom:8px}

    .section{border:1px solid var(--ps-border);border-radius:12px;padding:16px}

    /* Footer note */
    .footnote{font-size:12px;color:#5c6b78;margin-top:14px}

    /* Mobile */
    @media(max-width:960px){
      .layout{grid-template-columns:1fr}
      .sidebar{position:sticky;top:0;z-index:2}
      .row.cols-2,.row.cols-3{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div style="display:flex;align-items:center;gap:10px">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.77 5.82 22 7 14.14l-5-4.87 6.91-1.01L12 2z" fill="#7fb3d5"/></svg>
      <div class="app-title">Campus Solutions – Questionnaire Framework Mock</div>
    </div>
    <div class="env-pill">Demo · No backend</div>
  </header>

  <main class="layout">
    <aside class="sidebar" id="sidebar"></aside>
    <section class="content">
      <div class="card">
        <div class="card-hd">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
            <div>
              <div style="font-weight:700" id="view-title">Loading…</div>
              <div class="progress"><div id="progress-bar"></div></div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn ghost" id="resetPageBtn" title="Reset this page only">Reset Page</button>
              <button class="btn ghost" id="startOverBtn" title="Start over from beginning">Start Over</button>
            </div>
          </div>
        </div>
        <div class="card-bd" id="view-container"></div>
        <div class="actions">
          <button class="btn ghost" id="backBtn">Back</button>
          <button class="btn primary" id="nextBtn">Next</button>
        </div>
      </div>
      <div class="footnote">This mock uses Lone Star College's published TSI exemptions. For demo only.</div>
    </section>
  </main>

  <script>
    // ---------------------------
    // State
    // ---------------------------
    const state = {
      stepIndex: 0,
      // CS milestone flags (simulate): Y satisfied, N not satisfied
      milestones: { TSIR: 'N', TSIW: 'N', TISM: 'N' },
      answers: {
        reading: { selections: {}, proof:{sent:'', date:'', method:'', notes:''} },
        math:    { selections: {}, proof:{sent:'', date:'', method:'', notes:''} },
      },
      ui: {
        rw: { enroll:false, military:false, cpp:false, tests:false },
        m:  { enroll:false, military:false, cpp:false, tests:false }
      }
    };

    // Static text based on LSC page
    const EXPLAINS = {
      degree: 'You are exempt if you have graduated with an associate or baccalaureate degree from a U.S. Department of Education accredited postsecondary institution.',
      transfer_rw: 'You are exempt in Reading and Writing if you transferred to LSC from an eligible institution and have satisfactorily completed a college-level ENGLISH course.',
      transfer_m: 'You are exempt in Math if you transferred to LSC from an eligible institution and have satisfactorily completed a college-level MATH course.',
      priorReady: 'You are exempt if a prior college has already determined that you met college readiness standards.',
      activeDuty: 'You are exempt if you are serving on active duty in the U.S. armed forces, Texas National Guard, or a reserve component for at least three years preceding enrollment.',
      veteran: 'You are exempt if you were honorably discharged, retired, or released from active duty on or after August 1, 1990.',
      cpp: 'You are exempt in the content area if you successfully completed a college preparatory course through an LSC-partnered school district. Exemption lasts 24 months from high school graduation and requires enrolling in the first college-level course in that area in the first year at LSC.',
      nonDegree: 'Non-degree seeking students are TSI exempt.'
    };

    // Test-score options by area (thresholds summarized from LSC page)
    const TESTS = {
      rw: [
        { key:'act_rw_old', label:'ACT English 19 and Composite 23 (before Feb 15, 2023)' },
        { key:'act_rw_new', label:'ACT English + Reading (E+R) 40 or higher (on/after Feb 15, 2023)' },
        { key:'sat_rw',     label:'SAT Evidenced-Based Reading and Writing 480 or higher' },
        { key:'ged_rw',     label:'GED Reasoning Through Language Arts 165 or higher' },
        { key:'hiset_rw',   label:'HiSET Reading 15 and Writing 15 with Essay 4 or higher' },
        { key:'staar_eng3', label:'STAAR English III Level 2 score of 4000' },
      ],
      m: [
        { key:'act_m_old', label:'ACT Math 19 and Composite 23 (before Feb 15, 2023)' },
        { key:'act_m_new', label:'ACT Math 22 or higher (on/after Feb 15, 2023)' },
        { key:'sat_m',     label:'SAT Math 530 or higher' },
        { key:'ged_m',     label:'GED Mathematical Reasoning 165 or higher' },
        { key:'hiset_m',   label:'HiSET Mathematical Reasoning 15 or higher' },
        { key:'staar_alg2',label:'STAAR Algebra II Level 2 score of 4000' },
      ]
    };

    // Official submission methods based on LSC requirements
    const OFFICIAL_METHODS = {
      // For transcript-based exemptions
      transcript: [
        'Electronic via SPEEDE network (sent directly from institution)',
        'Official PDF emailed directly from college/university to Registrar@LoneStar.edu'
      ],
      // For test score exemptions
      act: [
        'Official ACT scores sent via ACT website to LSC (School Code: 006508)'
      ],
      sat: [
        'Official SAT scores sent via collegeboard.org to LSC (School Code: 006508)'
      ],
      ged: [
        'Official GED scores submitted via GED Testing Service Website'
      ],
      hiset: [
        'Official HiSET scores submitted via ETS HiSET Test website'
      ],
      staar: [
        'Official high school transcript sent directly from high school'
      ],
      // For other exemptions that may need documentation
      military: [
        'DD-214 or military documentation sent directly from military records',
        'Official military transcript or documentation mailed to LSC Registrar'
      ],
      cpp: [
        'Official high school transcript sent directly from high school',
        'Documentation from partnered school district sent to LSC'
      ]
    };

    const stepsStatic = [
      { key: 'intro',   label: 'Introduction' },
      { key: 'profile', label: 'Student flags' },
    ];

    function computeDynamicSteps(){
      const dyn = [];
      if (state.milestones.TSIR === 'N' || state.milestones.TSIW === 'N') dyn.push({ key:'rw_exempt', label:'Reading and Writing exemptions' });
      if (state.milestones.TISM === 'N') dyn.push({ key:'m_exempt', label:'Math exemptions' });
      dyn.push({ key:'summary', label:'Summary' });
      return [...stepsStatic, ...dyn];
    }

    // Helper function to determine official submission methods based on selections
    function getOfficialMethods(areaKey) {
      const selections = state.answers[areaKey].selections;
      const methods = [];

      // Check for transcript-based exemptions
      if (selections.degree || selections.transfer || selections.priorReady) {
        methods.push(...OFFICIAL_METHODS.transcript);
      }

      // Check for military exemptions
      if (selections.activeDuty || selections.veteran) {
        methods.push(...OFFICIAL_METHODS.military);
      }

      // Check for college prep course
      if (selections.cpp) {
        methods.push(...OFFICIAL_METHODS.cpp);
      }

      // Check for test score exemptions
      if (selections.act_rw_old || selections.act_rw_new || selections.act_m_old || selections.act_m_new) {
        methods.push(...OFFICIAL_METHODS.act);
      }
      if (selections.sat_rw || selections.sat_m) {
        methods.push(...OFFICIAL_METHODS.sat);
      }
      if (selections.ged_rw || selections.ged_m) {
        methods.push(...OFFICIAL_METHODS.ged);
      }
      if (selections.hiset_rw || selections.hiset_m) {
        methods.push(...OFFICIAL_METHODS.hiset);
      }
      if (selections.staar_eng3 || selections.staar_alg2) {
        methods.push(...OFFICIAL_METHODS.staar);
      }

      // Remove duplicates and return
      return [...new Set(methods)];
    }

    // ---------------------------
    // Render helpers
    // ---------------------------
    const viewTitle = document.getElementById('view-title');
    const viewContainer = document.getElementById('view-container');
    const sidebar = document.getElementById('sidebar');
    const progressBar = document.getElementById('progress-bar');
    const backBtn = document.getElementById('backBtn');
    const nextBtn = document.getElementById('nextBtn');
    const resetBtn = document.getElementById('resetBtn');

    function renderSidebar(){
      const all = computeDynamicSteps();
      sidebar.innerHTML = '';
      all.forEach((s, idx)=>{
        const el = document.createElement('div');
        el.className = 'step' + (idx === state.stepIndex ? ' active' : '');
        el.innerHTML = `<div class="index">${idx+1}</div><div class="label">${s.label}</div>`;
        el.addEventListener('click', ()=>{ state.stepIndex = idx; render(); });
        sidebar.appendChild(el);
      });
    }

    function setProgress(){
      const total = computeDynamicSteps().length;
      progressBar.style.width = (((state.stepIndex+1)/total)*100) + '%';
    }

    function render(){
      try {
        console.log('Rendering step:', state.stepIndex, 'Milestones:', state.milestones); // Debug log
        const stepsNow = computeDynamicSteps();
        const current = stepsNow[state.stepIndex];
        console.log('Current step key:', current.key, 'label:', current.label); // Debug log
        renderSidebar(); setProgress();
        viewTitle.textContent = current.label;
        switch(current.key){
          case 'intro': renderIntro(); break;
          case 'profile': renderProfile(); break;
          case 'rw_exempt': renderExemptions('rw'); break;
          case 'm_exempt': renderExemptions('m'); break;
          case 'summary': renderSummary(); break;
        }
        backBtn.disabled = state.stepIndex === 0;
        nextBtn.textContent = current.key === 'summary' ? 'Finish' : 'Next';
        console.log('Render complete'); // Debug log
      } catch (error) {
        console.error('Error in render():', error);
      }
    }

    // ---------------------------
    // Views
    // ---------------------------
    function renderIntro(){
      viewContainer.innerHTML = `
        <div class="row" style="gap:var(--space-4)">
          <div class="section">
            <p>This demo walks a student through <strong>TSI exemptions</strong> exactly as published by Lone Star College. It branches per content area and ends with a clear next step.</p>
            <ul>
              <li>Reading and Writing are grouped together where rules are identical.</li>
              <li>Math is handled separately.</li>
              <li><strong>NEW:</strong> Official submission methods are now tailored to your specific exemption type.</li>
            </ul>
            <details open>
              <summary>What counts as an exemption?</summary>
              <div class="hint">Degree earned, transfer with college-level coursework (English for Reading/Writing, Math for Math), prior readiness determination, certain military statuses, completion of a partnered college prep course, non-degree seeking, or meeting specific test-score thresholds on ACT, SAT, GED, HiSET, or STAAR.</div>
            </details>
            <p class="muted">No real data is stored. This is for presentation only.</p>
          </div>
        </div>`;
    }

    function renderProfile(){
      const { TSIR, TSIW, TISM } = state.milestones;
      viewContainer.innerHTML = `
        <div class="row cols-2">
          <div class="section">
            <label for="tsir">TSIR – Reading satisfied?</label>
            <select id="tsir">
              <option value="N" ${TSIR==='N'?'selected':''}>N – Not satisfied</option>
              <option value="Y" ${TSIR==='Y'?'selected':''}>Y – Satisfied</option>
            </select>
            <div class="hint">If set to N, Reading and Writing exemptions will be asked.</div>
          </div>
          <div class="section">
            <label for="tsiw">TSIW – Writing satisfied?</label>
            <select id="tsiw">
              <option value="N" ${TSIW==='N'?'selected':''}>N – Not satisfied</option>
              <option value="Y" ${TSIW==='Y'?'selected':''}>Y – Satisfied</option>
            </select>
            <div class="hint">If set to N, Reading and Writing exemptions will be asked.</div>
          </div>
          <div class="section">
            <label for="tism">TISM – Math satisfied?</label>
            <select id="tism">
              <option value="N" ${TISM==='N'?'selected':''}>N – Not satisfied</option>
              <option value="Y" ${TISM==='Y'?'selected':''}>Y – Satisfied</option>
            </select>
            <div class="hint">If set to N, Math exemptions will be asked.</div>
          </div>
                      <div class="section">
            <label>Load sample student</label>
            <div class="row cols-3">
              <button class="btn" id="sampleNeedsAll">Needs all</button>
              <button class="btn" id="sampleMathOnly">Math only</button>
              <button class="btn" id="sampleNone">All satisfied</button>
            </div>
          </div>
        </div>`;

      document.getElementById('tsir').addEventListener('change', e=>{ state.milestones.TSIR = e.target.value; clampStep(); render(); });
      document.getElementById('tsiw').addEventListener('change', e=>{ state.milestones.TSIW = e.target.value; clampStep(); render(); });
      document.getElementById('tism').addEventListener('change', e=>{ state.milestones.TISM = e.target.value; clampStep(); render(); });
      
      // Add sample button event listeners
      document.getElementById('sampleNeedsAll').addEventListener('click', () => loadSample('needsAll'));
      document.getElementById('sampleMathOnly').addEventListener('click', () => loadSample('mathOnly'));
      document.getElementById('sampleNone').addEventListener('click', () => loadSample('none'));
    }

    function renderExemptions(which){
      const isRW = which==='rw';
      const areaLabel = isRW ? 'Reading and Writing' : 'Math';
      const areaKey = isRW ? 'reading' : 'math';
      const testList = isRW ? TESTS.rw : TESTS.m;
      const sel = state.answers[areaKey].selections;
      const proof = state.answers[areaKey].proof;
      const ui = state.ui[which];

      viewContainer.innerHTML = `
        <div class="row">
          <div class="section">
            <p>Answer the questions below to see if you are <strong>TSI-exempt in ${areaLabel}</strong>. If none apply, you will need to take the TSIA2 ${isRW ? '' : 'Math '}assessment.</p>
          </div>

          <details id="d-enroll-${which}" ${ui.enroll ? 'open' : ''}>
            <summary>College enrollment or completion</summary>
            <div class="row">
              <div class="checklist">
                ${makeCheck('degree', 'I have an associate or bachelor\'s degree', sel.degree || false)}
                <div class="hint">${EXPLAINS.degree}</div>
              </div>
              <div class="checklist">
                ${makeCheck('transfer', isRW ? 'I transferred with completed college-level ENGLISH coursework with a passing grade' : 'I transferred with completed college-level MATH coursework with a passing grade', sel.transfer || false)}
                <div class="hint">${isRW ? EXPLAINS.transfer_rw : EXPLAINS.transfer_m}</div>
              </div>
              <div class="checklist">
                ${makeCheck('priorReady', 'A prior college already determined I was college ready', sel.priorReady || false)}
                <div class="hint">${EXPLAINS.priorReady}</div>
              </div>
              <div class="checklist">
                ${makeCheck('nonDegree', 'I am a non-degree seeking student', sel.nonDegree || false)}
                <div class="hint">${EXPLAINS.nonDegree}</div>
              </div>
            </div>
          </details>

          <details id="d-military-${which}" ${ui.military ? 'open' : ''}>
            <summary>Military status</summary>
            <div class="row">
              <div class="checklist">
                ${makeCheck('activeDuty', 'I have served on active duty for at least 3 years preceding enrollment', sel.activeDuty || false)}
                <div class="hint">${EXPLAINS.activeDuty}</div>
              </div>
              <div class="checklist">
                ${makeCheck('veteran', 'I was honorably discharged, retired, or released on or after Aug 1, 1990', sel.veteran || false)}
                <div class="hint">${EXPLAINS.veteran}</div>
              </div>
            </div>
          </details>

          <details id="d-cpp-${which}" ${ui.cpp ? 'open' : ''}>
            <summary>College preparatory course</summary>
            <div class="checklist">
              ${makeCheck('cpp', 'I completed a partnered high school College Preparatory Course in this subject within 24 months of HS graduation', sel.cpp || false)}
              <div class="hint">${EXPLAINS.cpp}</div>
            </div>
          </details>

          <details id="d-tests-${which}" ${ui.tests ? 'open' : ''}>
            <summary>Test score options (${areaLabel})</summary>
            <div class="checklist">
              ${testList.map(t => makeCheck(t.key, t.label, sel[t.key] || false)).join('')}
            </div>
          </details>

          <div class="section">
            ${exemptionDecision(areaKey) ? '<div class="pill">An exemption appears to apply in '+areaLabel+'</div>' : '<div class="pill bad">No exemptions selected</div>'}
            <div class="hint">You can select more than one if multiple apply.</div>
          </div>

          ${exemptionDecision(areaKey) ? proofBlock(areaKey, proof, which) : ''}

          <div class="pill note">If no exemptions apply in ${areaLabel}, you will need to take the TSIA2 ${isRW ? 'Reading and Writing' : 'Math'} assessment before registration.</div>
        </div>`;

      // wire up all checkboxes (with state persistence and live re-render)
      viewContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', e => {
          const key = e.target.dataset.key;
          if (key) {
            state.answers[areaKey].selections[key] = e.target.checked;
            // Clear the proof method when selections change since available methods may change
            if (state.answers[areaKey].proof.method) {
              const newMethods = getOfficialMethods(areaKey);
              if (!newMethods.includes(state.answers[areaKey].proof.method)) {
                state.answers[areaKey].proof.method = '';
              }
            }
            persistDetailsOpen(which);
            render();
          }
        });
      });

      // persist details open/close when user toggles the disclosure widgets
      ['enroll','military','cpp','tests'].forEach(k=>{
        const det = viewContainer.querySelector(`#d-${k}-${which}`);
        if (det){
          det.addEventListener('toggle', ()=>{ state.ui[which][k] = det.open; });
        }
      });

      // wire proof radio/selects/inputs with live re-render
      const sentY = viewContainer.querySelector(`#${areaKey}_proof_sent_y`);
      const sentN = viewContainer.querySelector(`#${areaKey}_proof_sent_n`);
      if (sentY) sentY.addEventListener('change', ()=>{ state.answers[areaKey].proof.sent='Y'; persistDetailsOpen(which); render(); });
      if (sentN) sentN.addEventListener('change', ()=>{ state.answers[areaKey].proof.sent='N'; persistDetailsOpen(which); render(); });
      const dateEl = viewContainer.querySelector(`#${areaKey}_proof_date`);
      if (dateEl) dateEl.addEventListener('change', e=>{ state.answers[areaKey].proof.date = e.target.value; });
      const methodEl = viewContainer.querySelector(`#${areaKey}_proof_method`);
      if (methodEl) methodEl.addEventListener('change', e=>{ state.answers[areaKey].proof.method = e.target.value; });
      const notesEl = viewContainer.querySelector(`#${areaKey}_proof_notes`);
      if (notesEl) notesEl.addEventListener('input', e=>{ state.answers[areaKey].proof.notes = e.target.value; });
    }

    function proofBlock(areaKey, proof, which){
      const officialMethods = getOfficialMethods(areaKey);
      
      return `
        <div class="section">
          <label>Have you already sent proof of your exemption for this area?</label>
          <div class="radio-group">
            <label class="radio"><input type="radio" name="${areaKey}_proof_sent" id="${areaKey}_proof_sent_y" ${proof.sent==='Y'?'checked':''}> <span>Yes</span></label>
            <label class="radio"><input type="radio" name="${areaKey}_proof_sent" id="${areaKey}_proof_sent_n" ${proof.sent==='N'?'checked':''}> <span>No</span></label>
          </div>

          ${proof.sent==='Y' ? `
          <div class="row cols-2" style="margin-top:12px">
            <div>
              <label for="${areaKey}_proof_date">When did you send it?</label>
              <input type="date" id="${areaKey}_proof_date" value="${escapeHtml(proof.date)}" />
              <div class="hint">An approximate date is fine.</div>
            </div>
            <div>
              <label for="${areaKey}_proof_method">How did you send it?</label>
              <select id="${areaKey}_proof_method">
                <option value="">Select official submission method…</option>
                ${officialMethods.map(m=>`<option value="${escapeHtml(m)}" ${proof.method===m?'selected':''}>${m}</option>`).join('')}
              </select>
              <div class="hint">Only official submission methods are shown based on your selections.</div>
            </div>
          </div>
          <div style="margin-top:12px">
            <label for="${areaKey}_proof_notes">Notes (optional)</label>
            <input type="text" id="${areaKey}_proof_notes" placeholder="Example: Sent ACT scores via MyACT portal" value="${escapeHtml(proof.notes)}"/>
          </div>
          ` : ''}

          ${proof.sent==='N' ? `
          <div class="pill note" style="margin-top:12px">
            To finalize your exemption, submit official proof using one of these methods:
            <ul style="margin-top:8px;margin-bottom:0">
              ${officialMethods.map(m => `<li>${m}</li>`).join('')}
            </ul>
          </div>
          ` : ''}
        </div>`;
    }

    function renderSummary(){
      const needRW = (state.milestones.TSIR==='N' || state.milestones.TSIW==='N');
      const needM = state.milestones.TISM==='N';
      const rwExempt = needRW ? exemptionDecision('reading') : true;
      const mExempt = needM ? exemptionDecision('math') : true;

      const cards = [];
      if (needRW){ cards.push(summaryCard('Reading and Writing', 'reading', rwExempt)); }
      if (needM){ cards.push(summaryCard('Math', 'math', mExempt)); }

      const allGood = cards.length===0 || cards.every(c => c.ok);

      viewContainer.innerHTML = `
        <div class="summary-list">
          ${cards.map(c => c.html).join('') || '<div class="muted">All areas are already satisfied.</div>'}
        </div>
        <div style="margin-top:16px">
          ${allGood ? '<div class="pill" style="background:#eef7ff;border-color:#cfe1ff;color:#1b6aa5">Ready to register</div>' : '<div class="pill bad">Action needed before registration</div>'}
        </div>`;
    }

    // ---------------------------
    // Helpers
    // ---------------------------
    function makeCheck(key, label, checked){
      return `<label class="check"><input type="checkbox" data-key="${key}" ${checked ? 'checked' : ''}> <span>${label}</span></label>`;
    }

    function exemptionDecision(areaKey){
      const s = state.answers[areaKey].selections || {};
      // Any exemption is valid (transfer no longer requires separate course check)
      return Object.entries(s).some(([k,v]) => v);
    }

    function listSelections(areaKey){
      const map = state.answers[areaKey].selections || {};
      const labels = {
        degree:'Degree earned', 
        transfer:'Transfer with college coursework', 
        priorReady:'Prior college readiness determination', 
        activeDuty:'Active duty', 
        veteran:'Veteran', 
        cpp:'College prep course', 
        nonDegree:'Non-degree seeking',
        act_rw_old:'ACT Eng 19 + Comp 23', 
        act_rw_new:'ACT E+R ≥ 40', 
        sat_rw:'SAT EBRW ≥ 480', 
        ged_rw:'GED RLA ≥ 165', 
        hiset_rw:'HiSET R15 W15 Essay≥4', 
        staar_eng3:'STAAR Eng III ≥ 4000',
        act_m_old:'ACT Math 19 + Comp 23', 
        act_m_new:'ACT Math ≥ 22', 
        sat_m:'SAT Math ≥ 530', 
        ged_m:'GED Math ≥ 165', 
        hiset_m:'HiSET Math ≥ 15', 
        staar_alg2:'STAAR Alg II ≥ 4000'
      };
      return Object.keys(map).filter(k=>map[k]).map(k=>labels[k]||k);
    }

    function summaryCard(label, areaKey, ok){
      const selections = listSelections(areaKey);
      const proof = state.answers[areaKey].proof;
      const needText = ok ? '' : `
        <div class="pill bad" style="margin-top:8px">No exemption selected · TSIA2 required</div>`;

      const proofHtml = ok ? `
        <div class="row tight" style="margin-top:8px">
          <div class="muted"><strong>Proof submitted:</strong> ${proof.sent==='Y' ? 'Yes' : proof.sent==='N' ? 'No' : 'Not answered'}</div>
          ${proof.sent==='Y' ? `<div class="muted">Date: ${proof.date || '—'}</div><div class="muted">Method: ${proof.method || '—'}</div>` : ''}
          ${proof.sent==='Y' && proof.notes ? `<div class="muted">Notes: ${escapeHtml(proof.notes)}</div>` : ''}
          ${proof.sent==='N' ? `<div class="pill note">Submit official proof to finalize this exemption.</div>` : ''}
        </div>` : '';

      return {
        ok,
        html: `<div class="summary-card">
          <div style="display:flex;align-items:center;justify-content:space-between"><strong>${label}</strong>
            ${ok ? '<span class="pill">Exemption applies</span>' : ''}
          </div>
          <div class="muted" style="margin-top:8px"><strong>Selected exemptions:</strong> ${selections.length ? selections.join(', ') : 'None'}</div>
          ${needText}
          ${proofHtml}
        </div>`
      };
    }

    function persistDetailsOpen(which){
      const dets = ['enroll','military','cpp','tests'];
      dets.forEach(k=>{
        const el = viewContainer.querySelector(`#d-${k}-${which}`);
        if (el) state.ui[which][k] = el.open;
      });
    }

    function loadSample(which){
      if (which==='needsAll'){
        state.milestones = { TSIR:'N', TSIW:'N', TISM:'N' };
      } else if (which==='mathOnly'){
        state.milestones = { TSIR:'Y', TSIW:'Y', TISM:'N' };
      } else if (which==='none'){
        state.milestones = { TSIR:'Y', TSIW:'Y', TISM:'Y' };
      }
      state.answers = {
        reading:{selections:{}, proof:{sent:'', date:'', method:'', notes:''}},
        math:{selections:{}, proof:{sent:'', date:'', method:'', notes:''}},
      };
      state.ui = { rw:{enroll:false, military:false, cpp:false, tests:false}, m:{enroll:false, military:false, cpp:false, tests:false} };
      state.stepIndex = 1;
      render();
    }

    // Make loadSample global so the buttons can access it
    window.loadSample = loadSample;

    function clampStep(){
      const total = computeDynamicSteps().length;
      if (state.stepIndex > total-1){ state.stepIndex = total-1; }
    }

    function escapeHtml(str){
      return (str||'').replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }

    function resetPage(){
      console.log('Reset page clicked!');
      const stepsNow = computeDynamicSteps();
      const current = stepsNow[state.stepIndex];
      
      switch(current.key){
        case 'profile':
          // Reset milestones to default
          state.milestones = { TSIR:'N', TSIW:'N', TISM:'N' };
          console.log('Reset profile page');
          break;
        case 'rw_exempt':
          // Reset reading selections and proof
          state.answers.reading = {selections:{}, proof:{sent:'', date:'', method:'', notes:''}};
          state.ui.rw = {enroll:false, military:false, cpp:false, tests:false};
          console.log('Reset reading/writing exemptions page');
          break;
        case 'm_exempt':
          // Reset math selections and proof
          state.answers.math = {selections:{}, proof:{sent:'', date:'', method:'', notes:''}};
          state.ui.m = {enroll:false, military:false, cpp:false, tests:false};
          console.log('Reset math exemptions page');
          break;
        case 'intro':
        case 'summary':
          console.log('No reset needed for this page');
          break;
      }
      
      render();
    }

    function startOver(){
      console.log('Start over clicked!');
      
      // Reset everything and go to beginning
      state.stepIndex = 0;
      state.milestones = { TSIR:'N', TSIW:'N', TISM:'N' };
      state.answers = {
        reading:{selections:{}, proof:{sent:'', date:'', method:'', notes:''}},
        math:{selections:{}, proof:{sent:'', date:'', method:'', notes:''}},
      };
      state.ui = { rw:{enroll:false, military:false, cpp:false, tests:false}, m:{enroll:false, military:false, cpp:false, tests:false} };
      
      console.log('Started over - back to introduction');
      render();
    }

    // Nav
    document.getElementById('backBtn').addEventListener('click', ()=>{ if (state.stepIndex>0){ state.stepIndex--; render(); }});
    document.getElementById('nextBtn').addEventListener('click', ()=>{
      const stepsNow = computeDynamicSteps();
      if (stepsNow[state.stepIndex].key === 'summary'){
        alert('Demo complete. In production, submission would record exemption or testing requirement.');
        return;
      }
      if (state.stepIndex < stepsNow.length-1){ state.stepIndex++; render(); }
    });

    // Kickoff
    render();
    
    // Setup button event listeners after initial render
    setTimeout(() => {
      const resetPageBtn = document.getElementById('resetPageBtn');
      const startOverBtn = document.getElementById('startOverBtn');
      
      if (resetPageBtn) {
        resetPageBtn.addEventListener('click', resetPage);
        console.log('Reset Page button event listener attached');
      } else {
        console.error('Reset Page button not found!');
      }
      
      if (startOverBtn) {
        startOverBtn.addEventListener('click', startOver);
        console.log('Start Over button event listener attached');
      } else {
        console.error('Start Over button not found!');
      }
    }, 100);
  </script>
</body>
</html>
